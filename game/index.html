---
layout: default
title: Game
full: true
---



<div id="gamescreen" class="game">
<div id="roomarea" class="room"></div>
<div id="hover" class="hover"></div>
<div id="console" class="console"></div>
</div>

<script>
var gameconsole = document.getElementById('console');
var gamescreen = document.getElementById('gamescreen');
var roomarea = document.getElementById('roomarea');
var main = document.getElementById('main');
var hover = document.getElementById('hover');




function logKey(e) {
    if (e.code == 'KeyS') {
        localStorage.setItem('save', JSON.stringify(globals) );
        console.log( JSON.parse(localStorage.getItem('save') ) );
        alert('Saved');
    } else if (e.code == 'KeyL') {
        load = localStorage.getItem('save');
        if(load) {
            globals = JSON.parse(load);
            console.log(globals);
            EnterRoom( globals.currentRoom );
            alert('Loaded');
        }
    }
}
document.addEventListener('keypress', logKey);


/*
var currentTimeout;
var currentMessages = 0;
var interfaceLocked = false;
var message = "Peer into darkness";

function logKey(e) {
    if (e.code == 'Space') {
        if(currentTimeout) clearTimeout( currentTimeout );
    }
}
document.addEventListener('keypress', logKey);


function mouseMove(e) {
    if( interfaceLocked ) return;
    var x = (e.clientX - main.offsetLeft);
    var y = (e.clientY - main.offsetTop);
    hover.style.left = x + "px";
    hover.style.top = y + "px";
    hover.innerHTML = message;
}
gamescreen.addEventListener('mousemove', mouseMove);


function say(message, id) {
    var promise, ms;
    ms = Math.max(1500,message.length*50);
    gameconsole.innerHTML = message;
    currentMessages++;
    promise = new Promise(function(resolve, reject) {
       
        currentTimeout = setTimeout(function() {
           currentMessages--;
            if(currentMessages==0) gameconsole.innerHTML = '';
            resolve('timeout done');
        }, ms);
    });
    return promise;
}


async function mouseDown(e) {
    if( interfaceLocked ) return;
    interfaceLocked = true;
    gamescreen.className += " nointerface";
    await darkness();
    interfaceLocked = false;
    gamescreen.className = gamescreen.className.replace(" nointerface", " interface");
}
gamescreen.addEventListener('mousedown', mouseDown);


async function darkness() {
    await say("It is so black...");
    await say("...I can barely see anything.");
    message = "Threaten rhinoceros";
    hover.innerHTML = '';
}
*/


var currentMessages = 0;
function Say(message, id) {
    var promise, ms;
    ms = Math.max(1500,message.length*50);
    gameconsole.innerHTML = message;
    currentMessages++;
    promise = new Promise(function(resolve, reject) {
        setTimeout(function() {
           currentMessages--;
            if(currentMessages==0) gameconsole.innerHTML = '';
            resolve('timeout done');
        }, ms);
    });
    return promise;
}

var interfaceLocked = false;
function EnableInterface() {
    interfaceLocked = false;
    gamescreen.className = gamescreen.className.replace(" nointerface", "");
}
function DisableInterface() {
    interfaceLocked = true;
    gamescreen.className += " nointerface";
}

var scripts = {};
var rooms = {};
var globals = {
    rooms : {}
};

var LastCreatedRoom;

function Room(name) {
    LastCreatedRoom = name;
    globals.rooms[name] = {
        hotspots : {}
    };
    return rooms[name] = {
        hotspots : {}
    };
}

function Hotspot(name,defaults) {
    room = LastCreatedRoom;
    globals.rooms[room].hotspots[name] = defaults;
    return rooms[room].hotspots[name] = {};
}


var overHotspot;
function mouseMove(e) {
    if( interfaceLocked ) return;
    var x = (e.clientX - main.offsetLeft);
    var y = (e.clientY - main.offsetTop);
    hover.style.left = x + "px";
    hover.style.top = y + "px";
    hover.innerHTML = overHotspot;
    overHotspot = '';
}
gamescreen.addEventListener('mousemove', mouseMove);



function WaitMiliseconds(ms) { 
  return new Promise(resolve => {
    setTimeout(() => {
      resolve('done');
    }, ms);
  });
}
function WaitSeconds(s) { 
  return new Promise(resolve => {
    setTimeout(() => {
      resolve('done');
    }, s*1000);
  });
}

async function HotspotClick( room, name) {
    if( interfaceLocked ) return;
    if( rooms[room] && rooms[room].hotspots[name] ) {
        if( rooms[room].hotspots[name].click ) {
            DisableInterface();
            await WaitSeconds(0.75);
            await rooms[room].hotspots[name].click( globals.rooms[room].hotspots[name], globals.rooms[room] );
            overHotspot = '';
            EnableInterface();
        }
    }
}

async function HotspotDisable( room, name) {
    if( rooms[room] && rooms[room].hotspots[name] ) {
        globals.rooms[room].hotspots[name].active = false;
        var id = document.getElementById(name);
        id.style.display = "none";
    }
}

async function HotspotEnable( room, name) {
    if( rooms[room] && rooms[room].hotspots[name] ) {
        globals.rooms[room].hotspots[name].active = true;
        var id = document.getElementById(name);
        id.style.display = "block";
    }
}


async function EnterRoom(name) {
    roomarea.innerHTML = '';
    if( rooms[name] && rooms[name].enter ) {
        globals.currentRoom = name;
        for(hotspot in rooms[name].hotspots) {
            var hotspotdiv = document.createElement("div");
            
            hotspotdiv.className = "game__hotspot";
            hotspotdiv.style.position = "absolute";
            hotspotdiv.style.left = globals.rooms[name].hotspots[hotspot].x;
            hotspotdiv.style.top = globals.rooms[name].hotspots[hotspot].y;
            hotspotdiv.style.width = globals.rooms[name].hotspots[hotspot].width;
            hotspotdiv.style.height = globals.rooms[name].hotspots[hotspot].height;
            if( globals.rooms[name].hotspots[hotspot].active == false) hotspotdiv.style.display = "none";
            if( globals.rooms[name].hotspots[hotspot].background ) hotspotdiv.style.background = globals.rooms[name].hotspots[hotspot].background;
            hotspotdiv.id = hotspot;

            hotspotdiv.onclick = function() {
                if( interfaceLocked ) return;
                HotspotClick(globals.currentRoom,this.id);
            };
            hotspotdiv.onmousemove = function(e) {
                overHotspot = globals.rooms[globals.currentRoom].hotspots[this.id].description;
            };
            /* hotspotdiv.attr( 'onclick', 'HotspotClick('+name+','+hotspot+')' ); */
            
            roomarea.appendChild(hotspotdiv);
        }
        await rooms[name].enter( globals.rooms[name] );
    }
}


(function() {
    {% include_relative example.js %}
})();

scripts.main();

</script>
